# Plugin Development Guide

This guide shows how to extend the WP Schema system.

## Table of Contents

1. [Quick Start](#quick-start)
2. [Architecture Overview](#architecture-overview)
3. [Creating Data Providers](#creating-data-providers)
4. [Registering Schema Types](#registering-schema-types)
5. [Using Hooks](#using-hooks)
6. [Value Objects](#value-objects)
7. [Validation](#validation)
8. [Caching](#caching)
9. [Examples](#examples)

---

## Quick Start

### Simple Example: Add Custom Data

````php
// Add custom organization data
WP_Schema::addFilter('wp_schema_type_data', function($schema, $type, $data) {\n    if ($type === 'Organization') {\n        $schema['customProperty'] = 'My Custom Value';\n    }\n    return $schema;\n}, 10, 3);\n```\n\n### Register a Custom Schema Type\n\n```php\nWP_Schema::registerSchemaType('Recipe', MyRecipeGenerator::class, [\n    'required_properties' => ['name', 'author'],\n    'allowed_properties' => ['name', 'author', 'ingredients', 'instructions']\n]);\n```\n\n### Create a Data Provider\n\n```php\nclass MyPluginProvider implements DataProviderInterface {\n    public function canProvide(string $context, array $options = []): bool {\n        return $context === 'singular' && get_post_type() === 'recipe';\n    }\n    \n    public function provide(string $context, array $options = []): array {\n        return [\n            '@type' => 'Recipe',\n            'name' => get_the_title(),\n            'author' => get_the_author()\n        ];\n    }\n    \n    // ... other required methods\n}\n\n// Register the provider\nWP_Schema::registerProvider(new MyPluginProvider());\n```\n\n---\n\n## Architecture Overview\n\nThe WP Schema system is built with clean architecture principles:\n\n```\n┌─────────────────────────────────────────────┐\n│                Plugin API                   │ ← Your plugins interact here\n├─────────────────────────────────────────────┤\n│              Schema Manager                 │ ← Orchestrates everything\n├─────────────────────────────────────────────┤\n│  Data Providers │ Registry │ Validation     │ ← Core services\n├─────────────────────────────────────────────┤\n│           Caching │ Hooks │ Models          │ ← Infrastructure\n└─────────────────────────────────────────────┘\n```\n\n### Key Components\n\n- **Data Providers**: Supply data for schema generation\n- **Schema Registry**: Manages schema types and generators\n- **Validation**: Ensures valid Schema.org output\n- **Caching**: High-performance caching with smart invalidation\n- **Hooks**: WordPress-style extensibility\n- **Models**: Type-safe value objects\n\n---\n\n## Creating Data Providers\n\nData providers are the primary way to add schema data to the system.\n\n### Basic Provider\n\n```php\nuse BuiltNorth\\Schema\\Contracts\\DataProviderInterface;\n\nclass MyProvider implements DataProviderInterface\n{\n    public function getProviderId(): string\n    {\n        return 'my_plugin_provider';\n    }\n    \n    public function canProvide(string $context, array $options = []): bool\n    {\n        // Only provide data for single posts\n        return $context === 'singular' && !empty($options['post_id']);\n    }\n    \n    public function provide(string $context, array $options = []): array\n    {\n        $post_id = $options['post_id'];\n        $post = get_post($post_id);\n        \n        if (!$post) {\n            return [];\n        }\n        \n        return [\n            '@type' => 'Article',\n            'name' => $post->post_title,\n            'description' => $post->post_excerpt,\n            'author' => get_the_author_meta('display_name', $post->post_author)\n        ];\n    }\n    \n    public function getCacheKey(string $context, array $options = []): string\n    {\n        return \"my_provider_{$context}_\" . ($options['post_id'] ?? 'none');\n    }\n    \n    public function getPriority(): int\n    {\n        return 20; // Higher than default providers\n    }\n    \n    public function getSupportedSchemaTypes(): array\n    {\n        return ['Article', 'BlogPosting'];\n    }\n    \n    public function isAvailable(): bool\n    {\n        return class_exists('MyPlugin'); // Check if your plugin is active\n    }\n}\n```\n\n### Advanced Provider with Value Objects\n\n```php\nuse BuiltNorth\\Schema\\Models\\Organization;\nuse BuiltNorth\\Schema\\Models\\Address;\nuse BuiltNorth\\Schema\\Models\\ImageObject;\n\nclass MyAdvancedProvider implements DataProviderInterface\n{\n    public function provide(string $context, array $options = []): array\n    {\n        // Use value objects for type safety\n        $address = Address::fromArray([\n            'street' => '123 Main St',\n            'city' => 'New York',\n            'state' => 'NY',\n            'zip' => '10001'\n        ]);\n        \n        $logo = ImageObject::fromUrl('https://example.com/logo.png');\n        \n        $organization = Organization::fromArray([\n            'name' => 'My Company',\n            'description' => 'We do great things',\n            'url' => 'https://example.com',\n            'address' => $address,\n            'logo' => $logo\n        ]);\n        \n        return $organization->toArray();\n    }\n    \n    // ... other methods\n}\n```\n\n### Register Your Provider\n\n```php\n// Register during plugin initialization\nadd_action('init', function() {\n    WP_Schema::registerProvider(new MyProvider());\n});\n```\n\n---\n\n## Registering Schema Types\n\nAdd support for new Schema.org types.\n\n### Create a Generator\n\n```php\nuse BuiltNorth\\Schema\\Generators\\BaseGenerator;\n\nclass RecipeGenerator extends BaseGenerator\n{\n    public static function generate(array $data, array $options = []): array\n    {\n        // Validate required data\n        if (!self::validate_data($data, ['name', 'author'])) {\n            return [];\n        }\n        \n        $schema = [\n            '@context' => 'https://schema.org',\n            '@type' => 'Recipe',\n            'name' => self::sanitize_text($data['name']),\n            'author' => self::create_nested_object('Person', [\n                'name' => $data['author']\n            ])\n        ];\n        \n        // Add optional fields\n        $optional_fields = [\n            'description' => 'description',\n            'image' => 'image',\n            'recipeIngredient' => 'ingredients',\n            'recipeInstructions' => 'instructions',\n            'cookTime' => 'cook_time',\n            'prepTime' => 'prep_time'\n        ];\n        \n        $schema = self::merge_optional_fields($schema, $data, $optional_fields);\n        \n        return $schema;\n    }\n}\n```\n\n### Register the Schema Type\n\n```php\nWP_Schema::registerSchemaType('Recipe', RecipeGenerator::class, [\n    'required_properties' => ['name', 'author'],\n    'allowed_properties' => [\n        'name', 'author', 'description', 'image', \n        'recipeIngredient', 'recipeInstructions', \n        'cookTime', 'prepTime', 'recipeYield'\n    ]\n]);\n```\n\n### Add Custom Validation\n\n```php\nWP_Schema::registerValidator('Recipe', function($schema) {\n    $errors = [];\n    $warnings = [];\n    \n    // Validate cook time format\n    if (isset($schema['cookTime']) && !preg_match('/^PT\\d+[HM]$/', $schema['cookTime'])) {\n        $warnings[] = 'Cook time should be in ISO 8601 duration format (e.g., PT30M)';\n    }\n    \n    // Validate ingredients\n    if (isset($schema['recipeIngredient']) && count($schema['recipeIngredient']) < 2) {\n        $warnings[] = 'Recipe should have at least 2 ingredients';\n    }\n    \n    return new \\BuiltNorth\\Schema\\Contracts\\ValidationResult(\n        empty($errors),\n        $errors,\n        $warnings\n    );\n});\n```\n\n---\n\n## Using Hooks\n\nThe system provides many hooks for customization.\n\n### Available Hooks\n\n| Hook | Description | Parameters |\n|------|-------------|------------|\n| `wp_schema_before_generation` | Before schema generation starts | `$context, $options, $manager` |\n| `wp_schema_after_generation` | After schemas are generated | `$schemas, $context, $options` |\n| `wp_schema_provider_data` | Filter data from providers | `$data, $context, $options, $manager` |\n| `wp_schema_type_data` | Filter generated schema | `$schema, $schemaType, $originalData` |\n| `wp_schema_context_schemas` | Filter schemas for context | `$schemas, $context, $options` |\n| `wp_schema_cache_key` | Filter cache key generation | `$cacheKey, $context, $options` |\n| `wp_schema_before_output` | Before schema output | `$schemas, $options` |\n\n### Hook Examples\n\n#### Modify Organization Schema\n\n```php\nWP_Schema::addFilter('wp_schema_type_data', function($schema, $type, $data) {\n    if ($type === 'Organization') {\n        // Add custom business hours from your plugin\n        $schema['openingHoursSpecification'] = get_option('my_plugin_hours', []);\n        \n        // Add social media from your plugin\n        $social = get_option('my_plugin_social', []);\n        if (!empty($social)) {\n            $schema['sameAs'] = array_merge($schema['sameAs'] ?? [], $social);\n        }\n    }\n    \n    return $schema;\n}, 10, 3);\n```\n\n#### Add Custom Context\n\n```php\nWP_Schema::addFilter('wp_schema_context_schemas', function($schemas, $context, $options) {\n    if ($context === 'singular' && get_post_type() === 'event') {\n        // Add Event schema for custom post type\n        $event_data = [\n            '@type' => 'Event',\n            'name' => get_the_title(),\n            'startDate' => get_post_meta(get_the_ID(), 'event_start', true),\n            'location' => [\n                '@type' => 'Place',\n                'name' => get_post_meta(get_the_ID(), 'event_location', true)\n            ]\n        ];\n        \n        $schemas[] = $event_data;\n    }\n    \n    return $schemas;\n}, 10, 3);\n```\n\n#### Cache Invalidation\n\n```php\nWP_Schema::addAction('wp_schema_after_generation', function($schemas, $context, $options) {\n    // Log schema generation for debugging\n    error_log(\"Generated \" . count($schemas) . \" schemas for context: $context\");\n}, 10, 3);\n```\n\n---\n\n## Value Objects\n\nUse type-safe value objects for complex data.\n\n### Address Example\n\n```php\nuse BuiltNorth\\Schema\\Models\\Address;\n\n$address = Address::fromArray([\n    'street' => '123 Main St',\n    'city' => 'New York', \n    'state' => 'NY',\n    'zip' => '10001',\n    'country' => 'US'\n]);\n\nif ($address->isValid()) {\n    $schema['address'] = $address->toArray();\n}\n```\n\n### Organization Example\n\n```php\nuse BuiltNorth\\Schema\\Models\\Organization;\nuse BuiltNorth\\Schema\\Models\\ImageObject;\n\n$logo = ImageObject::fromAttachment(123); // WordPress attachment ID\n\n$organization = Organization::fromArray([\n    'name' => 'My Company',\n    'type' => 'LocalBusiness',\n    'description' => 'We provide excellent services',\n    'url' => 'https://example.com',\n    'telephone' => '+1-555-123-4567',\n    'email' => 'info@example.com'\n])\n->setLogo($logo)\n->addSocialMedia('https://facebook.com/mycompany')\n->addSocialMedia('https://twitter.com/mycompany');\n\nif ($organization->isValid()) {\n    $schema = $organization->toArray();\n}\n```\n\n---\n\n## Validation\n\nEnsure your schemas are valid.\n\n### Validate a Schema\n\n```php\n$schema = [\n    '@context' => 'https://schema.org',\n    '@type' => 'Organization',\n    'name' => 'My Company'\n];\n\n$result = WP_Schema::validateSchema($schema, 'Organization');\n\nif (!$result['valid']) {\n    foreach ($result['errors'] as $error) {\n        error_log(\"Schema error: $error\");\n    }\n}\n\nif (!empty($result['warnings'])) {\n    foreach ($result['warnings'] as $warning) {\n        error_log(\"Schema warning: $warning\");\n    }\n}\n```\n\n### Custom Validation Rules\n\n```php\n// Add validation for your custom schema type\nWP_Schema::registerValidator('MyCustomType', function($schema) {\n    $errors = [];\n    \n    if (empty($schema['requiredCustomField'])) {\n        $errors[] = 'requiredCustomField is required for MyCustomType';\n    }\n    \n    return new ValidationResult(empty($errors), $errors);\n});\n```\n\n---\n\n## Caching\n\nThe system includes intelligent caching.\n\n### Automatic Cache Invalidation\n\nCache is automatically invalidated when:\n- Posts are saved/deleted\n- Terms are modified\n- Menus are updated\n- Theme options change\n- Your plugin is activated/deactivated\n\n### Manual Cache Control\n\n```php\n// Clear cache for specific post\nWP_Schema::clearCache('singular', ['post_id' => 123]);\n\n// Clear all cache\nwp_schema_cache()->flush();\n\n// Disable caching temporarily\nWP_Schema::setCachingEnabled(false);\n// ... do something ...\nWP_Schema::setCachingEnabled(true);\n```\n\n### Custom Cache Keys\n\n```php\nWP_Schema::addFilter('wp_schema_cache_key', function($key, $context, $options) {\n    // Add your plugin's version to cache key\n    if (!empty($options['my_plugin_data'])) {\n        $key .= '_myplugin_' . get_option('my_plugin_version');\n    }\n    return $key;\n}, 10, 3);\n```\n\n---\n\n## Examples\n\n### Complete Plugin Integration\n\n```php\n<?php\n/**\n * Plugin Name: My Schema Plugin\n */\n\nuse BuiltNorth\\Schema\\Contracts\\DataProviderInterface;\nuse BuiltNorth\\Schema\\Models\\Organization;\nuse BuiltNorth\\Schema\\Generators\\BaseGenerator;\n\n// Data Provider\nclass MyPluginProvider implements DataProviderInterface\n{\n    public function getProviderId(): string { return 'my_plugin'; }\n    public function getPriority(): int { return 15; }\n    public function isAvailable(): bool { return class_exists('MyPlugin'); }\n    \n    public function canProvide(string $context, array $options = []): bool\n    {\n        return $context === 'singular' && get_post_type() === 'my_custom_post';\n    }\n    \n    public function provide(string $context, array $options = []): array\n    {\n        return [\n            '@type' => 'MyCustomType',\n            'name' => get_the_title(),\n            'customField' => get_post_meta(get_the_ID(), 'my_custom_field', true)\n        ];\n    }\n    \n    public function getCacheKey(string $context, array $options = []): string\n    {\n        return \"my_plugin_{$context}_\" . ($options['post_id'] ?? 'none');\n    }\n    \n    public function getSupportedSchemaTypes(): array\n    {\n        return ['MyCustomType'];\n    }\n}\n\n// Schema Generator\nclass MyCustomTypeGenerator extends BaseGenerator\n{\n    public static function generate(array $data, array $options = []): array\n    {\n        if (!self::validate_data($data, ['name'])) {\n            return [];\n        }\n        \n        return self::add_context([\n            'name' => self::sanitize_text($data['name']),\n            'customField' => $data['customField'] ?? null\n        ], 'MyCustomType');\n    }\n}\n\n// Initialize\nadd_action('init', function() {\n    // Register provider\n    WP_Schema::registerProvider(new MyPluginProvider());\n    \n    // Register schema type\n    WP_Schema::registerSchemaType('MyCustomType', MyCustomTypeGenerator::class, [\n        'required_properties' => ['name'],\n        'allowed_properties' => ['name', 'customField', 'description']\n    ]);\n    \n    // Add custom validation\n    WP_Schema::registerValidator('MyCustomType', function($schema) {\n        $errors = [];\n        if (empty($schema['customField'])) {\n            $errors[] = 'customField is required';\n        }\n        return new \\BuiltNorth\\Schema\\Contracts\\ValidationResult(empty($errors), $errors);\n    });\n});\n\n// Modify existing schemas\nWP_Schema::addFilter('wp_schema_type_data', function($schema, $type, $data) {\n    if ($type === 'Organization') {\n        $schema['myPluginData'] = get_option('my_plugin_org_data');\n    }\n    return $schema;\n}, 10, 3);\n```\n\n### E-commerce Integration\n\n```php\nclass WooCommerceSchemaProvider implements DataProviderInterface\n{\n    public function canProvide(string $context, array $options = []): bool\n    {\n        return $context === 'singular' && \n               function_exists('wc_get_product') && \n               get_post_type() === 'product';\n    }\n    \n    public function provide(string $context, array $options = []): array\n    {\n        $product = wc_get_product($options['post_id'] ?? get_the_ID());\n        if (!$product) return [];\n        \n        return [\n            '@type' => 'Product',\n            'name' => $product->get_name(),\n            'description' => $product->get_short_description(),\n            'sku' => $product->get_sku(),\n            'image' => wp_get_attachment_image_url($product->get_image_id(), 'full'),\n            'offers' => [\n                '@type' => 'Offer',\n                'price' => $product->get_price(),\n                'priceCurrency' => get_woocommerce_currency(),\n                'availability' => $product->is_in_stock() ? \n                    'https://schema.org/InStock' : \n                    'https://schema.org/OutOfStock'\n            ]\n        ];\n    }\n    \n    // ... other required methods\n}\n```\n\n### Event Plugin Integration\n\n```php\nclass EventsSchemaProvider implements DataProviderInterface\n{\n    public function canProvide(string $context, array $options = []): bool\n    {\n        return $context === 'singular' && get_post_type() === 'tribe_events';\n    }\n    \n    public function provide(string $context, array $options = []): array\n    {\n        $event_id = $options['post_id'] ?? get_the_ID();\n        \n        return [\n            '@type' => 'Event',\n            'name' => get_the_title($event_id),\n            'description' => get_the_excerpt($event_id),\n            'startDate' => tribe_get_start_date($event_id, false, 'c'),\n            'endDate' => tribe_get_end_date($event_id, false, 'c'),\n            'location' => [\n                '@type' => 'Place',\n                'name' => tribe_get_venue($event_id),\n                'address' => tribe_get_full_address($event_id)\n            ],\n            'organizer' => [\n                '@type' => 'Organization',\n                'name' => tribe_get_organizer($event_id)\n            ]\n        ];\n    }\n    \n    // ... other required methods\n}\n```\n\nThis comprehensive foundation makes WP Schema THE standard for WordPress schema generation that any plugin can easily extend and enhance.\n"
````
